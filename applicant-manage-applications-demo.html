<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OR Tambo E-Recruitment Applicant CV</title>
  <style>
    :root {
      --sidebar:#313a44; --sidebar-border:#4a5360; --sidebar-text:#d8dee6; --sidebar-active:#147ff0;
      --bg:#eef1f6; --panel:#fff; --border:#dfe3e8; --text:#1f2937; --muted:#6b7280;
      --success:#12b76a; --warning:#f59e0b; --danger:#b42318;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Segoe UI",Tahoma,sans-serif;background:var(--bg);color:var(--text)}
    .layout{min-height:100vh;display:flex}
    .sidebar{width:310px;background:var(--sidebar);color:var(--sidebar-text);border-right:1px solid #27303a}
    .brand{display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid var(--sidebar-border);font-size:42px;font-weight:600;color:#fff}
    .search{padding:14px;border-bottom:1px solid var(--sidebar-border)}
    .search input{width:100%;border:1px solid #526170;background:#3e4a57;color:#fff;border-radius:5px;padding:10px 12px;font-size:16px}
    .menu{padding:10px;display:grid;gap:8px}
    .menu-item,.submenu-item{width:100%;border:0;border-radius:6px;text-align:left;background:transparent;color:var(--sidebar-text);padding:11px 12px;font-size:18px}
    .menu-item.active,.submenu-item.active{background:var(--sidebar-active);color:#fff;font-weight:600}
    .menu-group{background:#2e3742;border-radius:8px;border:1px solid #3e4956;overflow:hidden}
    .submenu{display:grid;padding:6px;background:#2a333d;border-top:1px solid #404b58;gap:6px}

    .content{flex:1;min-width:0}
    .topbar{height:72px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px}
    .badge{display:inline-block;border-radius:4px;padding:2px 8px;background:#16a34a;color:#fff;font-size:12px;margin-right:6px;font-weight:600}
    .page{padding:20px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .title-wrap{padding:22px 26px;border-bottom:1px solid var(--border)}
    .title-wrap h1{margin:0;font-size:48px;font-weight:500}

    .form-wrap{max-width:1180px;margin:0 auto;padding:20px 26px 28px}
    .section{border-top:1px solid #d8dde4;padding:18px 0}
    .section:first-child{border-top:0}
    .section h3{margin:0 0 10px;font-size:28px;font-weight:500}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px 16px}
    .field label{display:block;margin-bottom:6px;font-weight:600;font-size:16px}
    .field label .req{color:#ef4444}
    .field input,.field textarea,.field select{width:100%;border:1px solid #ced6df;border-radius:7px;padding:11px 12px;font-size:15px;font-family:inherit;background:#fff}
    .field textarea{min-height:96px;resize:vertical}
    .full{grid-column:1/-1}

    .upload-row{display:grid;grid-template-columns:170px 1fr 56px;max-width:760px}
    .upload-row button,.upload-row .file-name,.upload-row .remove-file{border:1px solid #ced6df;min-height:54px;display:flex;align-items:center;justify-content:center;background:#fff;font-size:15px}
    .upload-row button{border-radius:8px 0 0 8px;cursor:pointer}
    .upload-row .file-name{border-left:0;justify-content:flex-start;padding:0 12px;color:#0f7df2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .upload-row .remove-file{border-left:0;border-radius:0 8px 8px 0;cursor:pointer}
    input[type="file"]{display:none}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{border:0;border-radius:8px;padding:12px 18px;cursor:pointer;font-size:15px}
    .btn-primary{background:#0f7df2;color:#fff}
    .btn-success{background:#065f5b;color:#fff}
    .agree{display:flex;align-items:center;gap:10px;font-size:15px;margin-top:12px}
    .status{margin-top:10px;border-radius:8px;padding:10px 12px;font-size:14px;display:none}
    .status.show{display:block}
    .status.success{background:#ecfdf3;color:#065f46;border:1px solid #a7f3d0}
    .status.warning{background:#fffbeb;color:#92400e;border:1px solid #fcd34d}
    .status.error{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}

    @media (max-width:1100px){
      .layout{flex-direction:column}.sidebar{width:100%}.grid{grid-template-columns:1fr}.title-wrap h1{font-size:34px}
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://unpkg.com/mammoth@1.8.0/mammoth.browser.min.js"></script>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">üõ°Ô∏è OR Tambo</div>
      <div class="search"><input placeholder="search"></div>
      <nav class="menu">
        <button class="menu-item">üè† Dashboard</button>
        <div class="menu-group">
          <button class="menu-item active">‚öôÔ∏è Administration</button>
          <div class="submenu">
            <button class="submenu-item">üë§ Manage My Profile</button>
            <button class="submenu-item active">üìÑ My CV</button>
            <button class="submenu-item">üóÇÔ∏è My Applications</button>
          </div>
        </div>
      </nav>
    </aside>

    <main class="content">
      <header class="topbar">
        <div>‚ò∞ OR Tambo E‚ÄëRecruitment</div>
        <div><span class="badge">Applicant</span>abongile Goci</div>
      </header>
      <div class="page">
        <article class="card">
          <div class="title-wrap">
            <h1>OR Tambo E‚ÄëRecruitment Applicant CV</h1>
          </div>

          <form class="form-wrap" id="cvForm">
            <section class="section">
              <h3>Personal Information</h3>
              <div class="field full">
                <label>Upload your CV<span class="req">*</span></label>
                <div class="upload-row">
                  <button id="uploadTrigger" type="button">‚¨Ü Upload File</button>
                  <div class="file-name" id="fileName">No file selected</div>
                  <div class="remove-file" id="removeFile">üóë</div>
                </div>
                <input id="cvUpload" type="file" accept=".txt,.pdf,.docx,.doc" />
              </div>
              <div class="grid" style="margin-top:14px;">
                <div class="field"><label for="firstName">First Name<span class="req">*</span></label><input id="firstName" /></div>
                <div class="field"><label for="lastName">Last Name<span class="req">*</span></label><input id="lastName" /></div>
                <div class="field"><label for="email">Email<span class="req">*</span></label><input id="email" type="email" /></div>
                <div class="field"><label for="phone">Phone<span class="req">*</span></label><input id="phone" /></div>
              </div>
            </section>

            <section class="section">
              <h3>Address Information</h3>
              <div class="grid">
                <div class="field"><label for="city">City of Residence<span class="req">*</span></label><input id="city" /></div>
                <div class="field"><label for="country">Country<span class="req">*</span></label><select id="country"><option value="">Not Selected</option><option>South Africa</option><option>Lesotho</option><option>Namibia</option></select></div>
                <div class="field full"><label for="address">Full Address</label><textarea id="address"></textarea></div>
                <div class="field"><label for="postalCode">Postal Code</label><input id="postalCode" /></div>
              </div>
            </section>

            <section class="section">
              <h3>Qualifications</h3>
              <div class="grid">
                <div class="field"><label for="institution">Institution</label><input id="institution" /></div>
                <div class="field"><label for="qualification">Qualification Name</label><input id="qualification" /></div>
                <div class="field"><label for="fieldOfStudy">Field of Study</label><input id="fieldOfStudy" /></div>
                <div class="field"><label for="graduationDate">Graduation Date</label><input id="graduationDate" type="date" /></div>
              </div>
            </section>

            <section class="section">
              <h3>Certifications & Work Experience</h3>
              <div class="grid">
                <div class="field full"><label for="certifications">Certifications</label><textarea id="certifications"></textarea></div>
                <div class="field full"><label for="workExperience">Work Experience</label><textarea id="workExperience"></textarea></div>
              </div>
            </section>

            <section class="section">
              <h3>References, Soft Skills, Documents, Professional Body</h3>
              <div class="grid">
                <div class="field full"><label for="references">References</label><textarea id="references"></textarea></div>
                <div class="field full"><label for="softSkills">Soft Skills</label><textarea id="softSkills"></textarea></div>
                <div class="field full"><label for="documents">Additional Documents</label><textarea id="documents"></textarea></div>
                <div class="field full"><label for="professionalBody">Professional Body</label><textarea id="professionalBody"></textarea></div>
              </div>
            </section>

            <section class="section">
              <h3>Professional Profile</h3>
              <div class="grid">
                <div class="field"><label for="linkedin">LinkedIn Profile</label><input id="linkedin" placeholder="https://www.linkedin.com/in/your-profile" /></div>
                <div class="field"><label for="github">Github Profile</label><input id="github" placeholder="https://github.com/your-profile" /></div>
              </div>
              <label class="agree"><input type="checkbox" id="agreeTerms" /> I agree to <u>Candidate Terms</u></label>
              <div class="actions">
                <button class="btn btn-primary" id="saveBtn" type="button">Save Information</button>
                <button class="btn btn-success" id="submitBtn" type="button">Submit Application</button>
              </div>
              <div class="status" id="statusMsg"></div>
            </section>
          </form>
        </article>
      </div>
    </main>
  </div>

  <script>
    const storageKey = 'ortambo_cv_form_data_v1';
    const statusMsg = document.getElementById('statusMsg');
    const cvUpload = document.getElementById('cvUpload');
    const fileName = document.getElementById('fileName');
    const formFields = [
      'firstName','lastName','email','phone','city','country','address','postalCode','institution','qualification',
      'fieldOfStudy','graduationDate','certifications','workExperience','references','softSkills','documents',
      'professionalBody','linkedin','github'
    ];
    const cityList = ['Mthatha','Umtata','East London','Durban','Johannesburg','Cape Town','Pretoria','Bloemfontein','Gqeberha','Port Elizabeth','Polokwane','Nelspruit'];

    function showStatus(message, type='success') {
      statusMsg.textContent = message;
      statusMsg.className = `status show ${type}`;
      clearTimeout(showStatus.timer);
      showStatus.timer = setTimeout(() => statusMsg.className = 'status', 5500);
    }

    function setIfEmpty(id, value) {
      if (!value) return;
      const el = document.getElementById(id);
      if (!el.value.trim()) el.value = value.trim();
    }

    function saveFormToStorage() {
      const payload = {};
      formFields.forEach((id) => payload[id] = document.getElementById(id).value);
      payload.agreeTerms = document.getElementById('agreeTerms').checked;
      localStorage.setItem(storageKey, JSON.stringify(payload));
    }

    function loadFormFromStorage() {
      const raw = localStorage.getItem(storageKey);
      if (!raw) return;
      try {
        const payload = JSON.parse(raw);
        formFields.forEach((id) => { if (payload[id] !== undefined) document.getElementById(id).value = payload[id]; });
        document.getElementById('agreeTerms').checked = !!payload.agreeTerms;
      } catch { /* ignore bad stored state */ }
    }

    document.getElementById('uploadTrigger').addEventListener('click', () => cvUpload.click());
    document.getElementById('removeFile').addEventListener('click', () => {
      cvUpload.value = '';
      fileName.textContent = 'No file selected';
      showStatus('CV file removed.', 'warning');
    });

    async function extractTextFromPdf(file) {
      if (!window.pdfjsLib) throw new Error('PDF parser unavailable in this browser session.');
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const bytes = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
      let text = '';
      for (let i = 1; i <= pdf.numPages; i += 1) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += `${content.items.map((item) => item.str).join(' ')}\n`;
      }
      return text;
    }

    async function extractTextFromDocx(file) {
      if (!window.mammoth) throw new Error('DOCX parser unavailable in this browser session.');
      const result = await mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
      return result.value;
    }

    async function getCvText(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      if (ext === 'txt') return file.text();
      if (ext === 'pdf') return extractTextFromPdf(file);
      if (ext === 'docx') return extractTextFromDocx(file);
      if (ext === 'doc') throw new Error('DOC cannot be parsed directly. Use TXT/PDF/DOCX.');
      throw new Error('Unsupported file format. Use TXT, PDF, or DOCX.');
    }

    function inferNameFromFile(fileNameValue) {
      const base = fileNameValue.replace(/\.[^/.]+$/, '').replace(/[_-]+/g, ' ').replace(/\b(cv|resume|updated|final|copy|draft)\b/ig, ' ').replace(/\s+/g, ' ').trim();
      const parts = base.split(' ').filter(Boolean);
      if (parts.length >= 2) return { firstName: parts[0], lastName: parts[1] };
      return { firstName: '', lastName: '' };
    }

    function extractDetails(text, uploadName) {
      const lines = text.split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
      const email = text.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i)?.[0] || '';
      const phone = text.match(/(?:\+27|0)\s?\d{2}\s?\d{3}\s?\d{4}|\+?\d[\d\s-]{8,}/)?.[0] || '';

      let firstName = '';
      let lastName = '';
      const nameTagged = text.match(/(?:name|full\s*name)\s*[:\-]\s*([A-Za-z'-]+)\s+([A-Za-z'-]+)/i);
      if (nameTagged) {
        firstName = nameTagged[1];
        lastName = nameTagged[2];
      } else {
        const likelyName = lines.find((l) => /^[A-Za-z'-]{2,}\s+[A-Za-z'-]{2,}$/.test(l));
        if (likelyName) [firstName, lastName] = likelyName.split(/\s+/, 2);
      }
      if (!firstName || !lastName) {
        const fromFile = inferNameFromFile(uploadName);
        firstName ||= fromFile.firstName;
        lastName ||= fromFile.lastName;
      }
      if ((!firstName || !lastName) && email) {
        const u = email.split('@')[0].replace(/[._-]+/g, ' ');
        const parts = u.split(' ').filter(Boolean);
        if (parts.length >= 2) {
          firstName ||= parts[0];
          lastName ||= parts[parts.length - 1];
        }
      }

      const address = lines.find((line) => /(street|st\b|road|rd\b|avenue|ave|drive|dr\b|lane|ln\b|address)/i.test(line) && /\d/.test(line) && line.length < 140) || '';
      const cityTagged = text.match(/(?:city|city\s*of\s*residence)\s*[:\-]\s*([^\n\r]+)/i)?.[1]?.replace(/\b(country|province)\b.*$/i, '').trim() || '';
      let city = cityTagged;
      if (!city) city = cityList.find((c) => new RegExp(`\\b${c.replace(' ', '\\s+')}\\b`, 'i').test(text)) || '';
      const country = /south africa/i.test(text) ? 'South Africa' : '';
      const postalCode = (address.match(/\b\d{4}\b/) || text.match(/\b\d{4}\b/) || [''])[0];
      const linkedin = text.match(/https?:\/\/(www\.)?linkedin\.com\/[^\s]+/i)?.[0] || '';
      const github = text.match(/https?:\/\/(www\.)?github\.com\/[^\s]+/i)?.[0] || '';

      return { firstName, lastName, email, phone, address: address.replace(/^address\s*[:\-]?\s*/i,''), city, country, postalCode, linkedin, github };
    }

    function applyDetails(details) {
      setIfEmpty('firstName', details.firstName);
      setIfEmpty('lastName', details.lastName);
      setIfEmpty('email', details.email);
      setIfEmpty('phone', details.phone);
      setIfEmpty('address', details.address);
      setIfEmpty('city', details.city);
      setIfEmpty('postalCode', details.postalCode);
      setIfEmpty('linkedin', details.linkedin);
      setIfEmpty('github', details.github);
      if (!document.getElementById('country').value && details.country) document.getElementById('country').value = details.country;
    }

    cvUpload.addEventListener('change', async () => {
      const file = cvUpload.files[0];
      fileName.textContent = file ? file.name : 'No file selected';
      if (!file) return;
      try {
        const text = await getCvText(file);
        applyDetails(extractDetails(text, file.name));
        saveFormToStorage();
        showStatus('CV uploaded and form auto-filled automatically.', 'success');
      } catch (error) {
        showStatus(error.message, 'error');
      }
    });

    document.getElementById('saveBtn').addEventListener('click', () => {
      saveFormToStorage();
      showStatus('Information saved successfully.', 'success');
    });

    document.getElementById('submitBtn').addEventListener('click', () => {
      const required = ['firstName','lastName','email','phone','city','country'];
      const missing = required.filter((id) => !document.getElementById(id).value.trim());
      if (!cvUpload.files[0]) return showStatus('Please upload your CV before submitting.', 'warning');
      if (missing.length) return showStatus('Please complete required fields before submitting.', 'warning');
      if (!document.getElementById('agreeTerms').checked) return showStatus('Please agree to Candidate Terms.', 'warning');
      saveFormToStorage();
      showStatus(`Application submitted successfully with CV "${cvUpload.files[0].name}" (demo).`, 'success');
    });

    loadFormFromStorage();
  </script>
</body>
</html>
